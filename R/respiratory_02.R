#' Respiratory-02 Calculation
#'
#' The `respiratory_02` function calculates metrics for pediatric and adult
#' respiratory populations based on pre-defined criteria, such as low oxygen
#' saturation and specific medication or procedure codes. It returns a summary
#' table of the overall, pediatric, and adult populations, showing counts and
#' proportions.
#'
#' @section Data Assumptions:
#' Assume data are already loaded The data must be a dataframe or tibble that
#' contains emedications.03 and eprocedures.03 as columns where each cell
#' contains all values entered for each respective incident. These are not list
#' columns but can be comma separated values in each cell, and must contain all
#' medications for each incident. The table must also have the erecord.01 values
#' to attempt a best estimate of a unique ID by concatenating the erecord.01,
#' incident date, and patient DOB. The table can include all values entered for
#' evitals.12 in the table.  This will cause row explosion, but the function
#' will find if the patient had sp02 < 90 among any values entered. This
#' function assumes you have the following fields: eRecord.01, eresponse.05
#' (must contain code), evitals.12 (all values), emedications.03 (all with
#' code), eprocedures.03 (with code) this function will calculate age in years
#' for the end user. this function also assumes that rows that are missing any
#' value are NA, not the not known / not recorded values common to ImageTrend or
#' the value codes that correspond to "not values". the first argument is a
#' dataframe, no joining is done in the function. any needed table joins must be
#' done prior to running the function to ensure required columns are present.
#' Grouping by specific attributes (e.g., region) can be performed inside this function by
#' utilizing the `.by` argument passed via tidydots (i.e. `...`) to `dplyr::summarize`.
#'
#'
#' @param df  Data frame or tibble containing EMS incident data.
#' @param erecord_01_col Column name for eRecord.01, used to form a unique patient ID.
#' @param incident_date_col Date or POSIXct Column name for the incident date.
#' @param patient_DOB_col Date or POSIXct Column name for the patient's date of birth.
#' @param epatient_15_col integer Column giving the calculated age value.
#' @param epatient_16_col Column giving the provided age unit value.
#' @param eresponse_05_col Column name for response codes (e.g., incident type).
#' @param evitals_12_col Column name for oxygen saturation (SpO2) values.
#' @param emedications_03_col Column name for medication codes.
#' @param eprocedures_03_col Column name for procedure codes.
#' @param ... arguments passed to `dplyr::summarize()`.
#'
#' @return Returns a tibble summarizing the overall and age-grouped respiratory-02 metrics, formatted for ease of interpretation.
#' 
#' @section Credit:
#' 
#' This function was developed by (Nicolas Foss, Ed.D., MS)[nicolas.foss@hhs.iowa.gov] at the Bureau of Emergency Medical and Trauma 
#' Services, Division of Public Health, Iowa HHS.
#' 
#' @export
respiratory_02 <- function(df,
                           erecord_01_col,
                           incident_date_col,
                           patient_DOB_col,
                           epatient_15_col,
                           epatient_16_col,
                           eresponse_05_col,
                           evitals_12_col,
                           emedications_03_col,
                           eprocedures_03_col,
                           ...) {

  # provide better error messaging if df is missing
  if (missing(df)) {
    cli::cli_abort(
      c(
        "No object of class {.cls data.frame} was passed to {.fn respiratory_01}.",
        "i" = "Please supply a {.cls data.frame} to the first argument in {.fn respiratory_01}."
      )
    )
  }

  # Ensure df is a data frame or tibble
  if (!is.data.frame(df) && !tibble::is_tibble(df)) {
    cli::cli_abort(
      c(
        "An object of class {.cls data.frame} or {.cls tibble} is required as the first argument.",
        "i" = "The passed object is of class {.val {class(df)}}."
      )
    )
  }

  # use quasiquotation on the date variables to check format
  incident_date <- rlang::enquo(incident_date_col)
  patient_DOB <- rlang::enquo(patient_DOB_col)

  if ((!lubridate::is.Date(df[[rlang::as_name(incident_date)]]) &
    !lubridate::is.POSIXct(df[[rlang::as_name(incident_date)]])) ||
    (!lubridate::is.Date(df[[rlang::as_name(patient_DOB)]]) &
      !lubridate::is.POSIXct(df[[rlang::as_name(patient_DOB)]]))) {
    cli::cli_abort(
      "For the variables {.var incident_date_col} and {.var patient_DOB_col}, one or both of these variables were not of class {.cls Date} or a similar class.  Please format your {.var incident_date_col} and {.var patient_DOB_col} to class {.cls Date} or similar class."
    )
  }


  # 911 codes for eresponse.05
  codes_911 <- "2205001|2205003|2205009"

  # minor values
  minor_values <- "days|hours|minutes|months"

  # not values for meds
  not_med <- "8801001|8801003|8801009|8801019|8801027"

  # not values for procedures
  not_proc <- "8801001|8801023|8801003|8801019|8801027"
  # some manipulations to prepare the table
  # create the patient age in years and the patient age in days variables for filters
  # create the unique ID variable
  initial_population_0 <- df |>
    dplyr::mutate(
      patient_age_in_years = as.numeric(difftime(
        time1 = {{ incident_date_col }},
        time2 = {{ patient_DOB_col }},
        units = "days"
      )) / 365,
      patient_age_in_days = as.numeric(difftime(
        time1 = {{ incident_date_col }},
        time2 = {{ patient_DOB_col }},
        units = "days"
      )),
      # get 911 variable
      call_911 = grepl(
        pattern = codes_911,
        x = {{ eresponse_05_col }},
        ignore.case = T
      ),

      # get sp02 variable
      pulse_oximetry_check = {{ evitals_12_col }} < 90,

      # system age checks
      system_age_adult = {{ epatient_15_col }} >= 18 & {{ epatient_16_col }} == "Years",
      system_age_minor1 = {{ epatient_15_col }} < 18 & {{ epatient_16_col }} == "Years",
      system_age_minor2 = {{ epatient_15_col }} <= 120 & grepl(pattern = minor_values, x = {{ epatient_16_col }}, ignore.case = T),
      system_age_minor = system_age_minor1 | system_age_minor2,
      system_age_minor_exclusion1 = {{ epatient_15_col }} < 24 & {{ epatient_16_col }} == "Hours",
      system_age_minor_exclusion2 = {{ epatient_15_col }} < 120 & {{ epatient_16_col }} == "Minutes",
      system_age_minor_exclusion = system_age_minor_exclusion1 | system_age_minor_exclusion2,

      # calculated age checks
      calc_age_adult = patient_age_in_years >= 18,
      calc_age_minor = patient_age_in_years < 18 & patient_age_in_days >= 1,

      # oxygen variable for numerator
      oxygen_med = grepl(pattern = "7806", x = {{ emedications_03_col }}) &
        !grepl(pattern = not_med, x = {{ emedications_03_col }}, ignore.case = T),
      oxygen_proc = grepl(pattern = "57485005", x = {{ eprocedures_03_col }}, ignore.case = T) &
        !grepl(pattern = not_proc, x = {{ eprocedures_03_col }}, ignore.case = T)
    )

  # finish filters and make the table distinct
  initial_population <- initial_population_0 |>
    dplyr::filter(

      # pulse oximetry < 90
      pulse_oximetry_check,

      # 911 calls
      call_911
    ) |>
    dplyr::mutate(INCIDENT_DATE_MISSING = tidyr::replace_na({{ incident_date_col }}, as.Date("1984-09-01")),
                  PATIENT_DOB_MISSING = tidyr::replace_na({{ incident_date_col }}, as.Date("1984-05-01")),
                  Unique_ID = stringr::str_c({{erecord_01_col}}, INCIDENT_DATE_MISSING, PATIENT_DOB_MISSING, sep = "-")) |>
    dplyr::distinct(Unique_ID, .keep_all = T) # this will ensure each row is an observation, and each column is a feature

  # get population 1 for respiratory-02, peds
  respiratory_02_peds <- initial_population |>
    dplyr::filter((system_age_minor & !system_age_minor_exclusion) |
      calc_age_minor)

  # get population 2 for respiratory-02, adults
  respiratory_02_adults <- initial_population |>
    dplyr::filter(system_age_adult | calc_age_adult)

  # calculations for peds
  peds_calculation <- respiratory_02_peds |>
    dplyr::summarize(
      measure = "Respiratory-02",
      pop = "Peds",
      numerator = sum(
        oxygen_med | oxygen_proc,
        na.rm = T
      ),
      denominator = dplyr::n(),
      prop = sum(
        oxygen_med | oxygen_proc,
        na.rm = T
      ) / dplyr::n(),
      prop_label = pretty_percent(prop, n_decimal = 0.01),
      ...
    )

  # calculations for adults
  adults_calculation <- respiratory_02_adults |>
    dplyr::summarize(
      measure = "Respiratory-02",
      pop = "Adults",
      numerator = sum(
        oxygen_med | oxygen_proc,
        na.rm = T
      ),
      denominator = dplyr::n(),
      prop = sum(
        oxygen_med | oxygen_proc,
        na.rm = T
      ) / dplyr::n(),
      prop_label = pretty_percent(prop, n_decimal = 0.01),
      ...
    )

  # bind rows of calculations for final table
  respiratory.02 <- dplyr::bind_rows(peds_calculation, adults_calculation)

  respiratory.02
}
